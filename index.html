<!DOCTYPE html>

<html lang="ko">
<head>
<meta content="MBC ì¸ì œìŠ¤íŠ¸ Note" property="og:title"/>
<meta content="MBC ì´¬ì˜ ì¸ì œìŠ¤íŠ¸ ë‚´ìš©ì„ ê¸°ë¡í•˜ê³  ê³µìœ í•˜ì„¸ìš”." property="og:description"/>
<meta content="mbc_logo.jpg" property="og:image"/>
<meta content="https://kunhoyoo.github.io/MBC_INGEST/" property="og:url"/>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>MBC ì¸ì œìŠ¤íŠ¸ Note</title>
<link href="https://fonts.googleapis.com/css2?family=Nanum+Barun+Gothic&amp;display=swap" rel="stylesheet"/>
<style>
    body {
      font-family: 'Nanum Barun Gothic', sans-serif;
      background: #f7f7f7;
      margin: 0;
      padding: 1rem;
      text-align: center;
    }
    h1 {
      color: #004080;
      cursor: pointer;
    }
    .form-group {
      margin-bottom: 1rem;
      text-align: left;
      max-width: 700px;
      margin-left: auto;
      margin-right: auto;
    }
    label {
      display: block;
      font-weight: bold;
      margin-bottom: 0.3rem;
    }
    input, textarea {
      white-space: pre-wrap;
      width: 95%;
      padding: 0.5rem;
      font-size: 1rem;
      border: 1px solid #ccc;
      border-radius: 5px;
    }
    textarea#content {
      height: 300px !important;
    }
    #login-code {
      width: 300px;
      margin: 0 auto;
      display: block;
      text-align: center;
    }
    button {
      background: #004080;
      color: white;
      padding: 0.75rem 0.5rem;
      font-size: 0.9rem;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      margin: 0.2rem;
    }
    button:hover {
      background: #003060;
    }
    button.reset-btn {
      background: #002244;
    }
    button.reset-btn:hover {
      background: #001a33;
    }
    .btn-row {
      display: flex;
      justify-content: center;
      flex-wrap: nowrap;
      gap: 0.3rem;
      margin-top: 1.5rem;
    }
    .btn-row button {
      width: 18%;
      max-width: 80px;
      font-size: 0.75rem;
      padding: 0.5rem 0.4rem;
    }
    #login-section, #form-section {
      max-width: 700px;
      margin: auto;
      display: none;
    }
    #login-section.active, #form-section.active {
      display: block;
    }
    #sms-popup {
      position: fixed;
      top: 30%;
      left: 50%;
      transform: translate(-50%, -30%);
      background: white;
      padding: 20px;
      border: 2px solid #004080;
      border-radius: 8px;
      z-index: 1000;
      width: 80%;
      max-width: 500px;
      display: none;
    }
    #sms-popup textarea {
      width: 100%;
      height: 120px;
      margin-bottom: 10px;
    }
    #sms-popup .btn-row {
      display: flex;
      justify-content: flex-end;
    }
  </style>
</head>
<body>
<div id="login-logo-wrapper" style="display: none;"><br/><br/><br/><br/><br/><img alt="MBC ì¸ì œìŠ¤íŠ¸ Note" onclick="location.reload()" src="title_logo.png" style="cursor:pointer; max-width: 400px; width: 50%; height: auto; margin: 30px auto 10px auto; display: block;"/></div>
<div class="active" id="login-section">
<div class="form-group" style="text-align: center;">
<input id="login-code" maxlength="10" placeholder="ì½”ë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”" style="width: 340px;" type="password"/>
</div>
<div style="margin-top: 0.5rem; text-align: center;">
<button id="login-btn" onclick="login()" style="width: 358px;">ë¡œ ê·¸ ì¸</button>
<button onclick="window.location.href='https://kunhoyoo.github.io/MBC_MNG/'" style="width: 358px;">M N G</button>
<button onclick="goToRecordPage()" style="width: 358px;">ê¸° ã€€ ë¡</button>
<button id="meal-btn" onclick="showMealPage()" style="width: 358px;">ì‹ ë‹¨ í‘œ</button>
<button onclick="showAudioProcess()" style="width: 358px;">ì‹ ì… í™•ì¸</button>

</div>
</div>
<div id="form-section">
<img alt="MBC ì¸ì œìŠ¤íŠ¸ Note" onclick="goToLogin()" src="title_logo.png" style="cursor:pointer; max-width: 400px; width: 50%; height: auto; margin: 30px auto 10px auto; display: block;"/>
<div class="form-group"><label>ì˜ë¢°ì</label><input id="client" type="text"/></div>
<div class="form-group"><label>ì˜ë¢°í˜•ì‹</label><input id="request_type" type="text" value="ì›ë³¸"/></div>
<div class="form-group"><label>ì´¬ì˜ì¼</label><input id="shoot_date" type="date"/></div>
<div class="form-group"><label>ê¸°ì ë™í–‰ ì—¬ë¶€</label><input id="reporter_accompany" type="text"/></div>
<div class="form-group"><label>ëŒ€ë¶„ë¥˜</label><input id="category_main" type="text"/></div>
<div class="form-group"><label>ì†Œë¶„ë¥˜</label><input id="category_sub" type="text"/></div>
<div class="form-group"><label>ì œëª©</label><input id="title" type="text"/></div>
<div class="form-group"><label>íŠ¹ì´ì‚¬í•­</label><textarea id="notes"></textarea></div>
<div class="form-group"><label>ì´¬ì˜ë‚´ìš©</label><textarea id="content"></textarea></div>
<div class="form-group"><label>ì´¬ì˜ì¥ì†Œ</label><input id="location" type="text"/></div>
<div class="form-group"><label>ì˜ìƒê¸°ì</label><input id="videographer" type="text"/></div>
<div class="form-group"><label>ì·¨ì¬ê¸°ì</label><input id="reporter" type="text"/></div>
<div class="form-group"><label>ì˜ìƒPD/VJ</label><input id="vj" type="text"/></div>
<div class="form-group"><label>ì¹´ë“œë²ˆí˜¸</label><input id="card_number" type="text"/></div>
<div class="form-group"><label>ì´¬ì˜ì¥ë¹„</label><input id="equipment" type="text"/></div>
<div class="btn-row">
<button class="reset-btn" onclick="confirmReset()">ë¦¬ì…‹</button>
<button onclick="openSMSPopup()">ì˜ë¢° ë‚´ìš©</button>
<button onclick="copyAndShare()">ë³µì‚¬</button>
<button onclick="downloadTXT()">ì¶”ì¶œ</button>
<button onclick="saveToServer()">ì„œë²„</button>
</div>
</div>
<div id="sms-popup">
<textarea id="sms-text" placeholder="ì˜ë¢° ë‚´ìš©ì„ ë¶™ì—¬ë„£ê¸° í•˜ì„¸ìš”
[Webë°œì‹ ] &lt;- ì‚­ì œ í›„ ì…ë ¥ í•„ìš”"></textarea>
<div class="btn-row">
<button onclick="parseSMSAndInsert()">ì…ë ¥</button>
<button onclick="closeSMSPopup()">ì·¨ì†Œ</button>
</div>
</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
<script>
  const firebaseConfig = {
    apiKey: "AIzaSyACkd1QzPgDnmRz3b206e4IiePiS55keio",
    authDomain: "mbc-ingest.firebaseapp.com",
    databaseURL: "https://mbc-ingest-default-rtdb.firebaseio.com",
    projectId: "mbc-ingest",
    storageBucket: "mbc-ingest.firebasestorage.app",
    messagingSenderId: "700019516",
    appId: "1:700019516:web:09f8b929973059316ea439"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();
  const allowedCodes = [
      "0001","0002","0003","0004","0005","wodyd1","wodyd2","wodyd3","wodyd4","wodyd5","qhtjd1","qhtjd2","qhtjd3","qhtjd4","qhtjd5","gustn1","rudgus1","rudgus2","rudgus3","rudgus4","rudgus5","gustn2","gustn3","gustn4","gustn5","ghdcks1","ghdcks2","ghdcks3","ghdcks4","ghdcks5","alstkd1","alstkd2","alstkd3","alstkd4","alstkd5","ehddh1","ehddh2","ehddh3","ehddh4","ehddh5","eowns1","eowns2","eowns3","eowns4","eowns5","tjddh1","tjddh2","tjddh3","tjddh4","tjddh5",    "rjsgh1", "rjsgh2",  "rjsgh3",  "rjsgh4",  "rjsgh5",  "wlsaud1",  "wlsaud2",  "wlsaud3",  "wlsaud4",  "wlsaud5",  "rlaalswns1",  "rlaalswns2",  "rlaalswns3",  "rlaalswns4",  "rlaalswns5",  "tmdals1",  "tmdals2",  "tmdals3",  "tmdals4",  "tmdals5",  "dudwls1",  "dudwls2",  "dudwls3",  "dudwls4",  "dudwls5",  "dydxo1",  "dydxo2",  "dydxo3",  "dydxo4",  "dydxo5",  "wotmd1",  "wotmd2",  "wotmd3",  "wotmd4",  "wotmd5",  "wodnd1",  "wodnd2",  "wodnd3", "tjrdnjs1", "tjrdnjs2","tjrdnjs3","tjrdnjs4","tjrdnjs5", "tkdals1", "tkdals2", "tkdals3", "tkdals4", "tkdals5",
  "wodnd4",  "wodnd5", "wogur1","wogur2","wogur3","wogur4","wogur5", "whddns1",  "whddns2",  "whddns3",  "whddns4",  "whddns5",  "xowns1",  "xowns2",  "xowns3",  "xowns4",  "xowns5",  "tmdgh1",  "tmdgh2",  "tmdgh3",  "tmdgh4",  "tmdgh5",  "wogud1",  "wogud2",  "wogud3",  "wogud4",  "wogud5",  "wndud1",  "wndud2",  "wndud3",  "wndud4",  "wndud5",  "cksgus1",  "cksgus2",  "cksgus3",  "cksgus4",  "cksgus5",  "wnsgml1",  "wnsgml2",  "wnsgml3",  "wnsgml4",  "wnsgml5",  "tlaalswns1",  "tlaalswns2",  "tlaalswns3",  "tlaalswns4",  "tlaalswns5",  "tmdghks1",  "tmdghks2",  "tmdghks3",  "tmdghks4",  "tmdghks5",  "guswls1",  "guswls2",  "guswls3",  "guswls4",  "guswls5",  "alswnd1",  "alswnd2",  "alswnd3",  "alswnd4",  "alswnd5",  "alstkd1",  "alstkd2",  "alstkd3",  "alstkd4",  "alstkd5",  "wogk1",  "wogk2",  "wogk3",  "wogk4",  "wogk5",  "wlsgks1",  "wlsgks2",  "wlsgks3",  "wlsgks4",  "wlsgks5",  "gkswns1",  "gkswns2",  "gkswns3",  "gkswns4",  "gkswns5",  "gusdyd1",  "gusdyd2",  "gusdyd3",  "gusdyd4",  "gusdyd5",  "ehfbs1",  "ehfbs2",  "ehfbs3",  "ehfbs4",  "ehfbs5",  "wlgur1",  "wlgur2",  "wlgur3",  "wlgur4",  "wlgur5",  "gnldyd1",  "gnldyd2",  "gnldyd3",  "gnldyd4",  "gnldyd5",  "alsdnr1",  "alsdnr2",  "alsdnr3",  "alsdnr4",  "alsdnr5",  "woghks1",  "woghks2",  "woghks3",  "woghks4",  "woghks5",  "wogns1",  "wogns2",  "wogns3",  "wogns4",  "wogns5"
];
  let currentUser = null;

  function login() {
    currentUser = document.getElementById('login-code').value;
    if (allowedCodes.includes(currentUser)) {
      document.getElementById('login-section').classList.remove('active');
      document.getElementById('form-section').classList.add('active');
      loadData();
      loadFromServer();
      setDefaultDate();
    } else {
      alert('ì˜ëª»ëœ ë¡œê·¸ì¸ ì½”ë“œì…ë‹ˆë‹¤.');
    }
  }

  function goToLogin() {
    document.getElementById('form-section').classList.remove('active');
    document.getElementById('login-section').classList.add('active');
    currentUser = null;
  }

  function resetForm() {
    document.querySelectorAll('#form-section input, #form-section textarea').forEach(el => el.value = '');
    document.getElementById('request_type').value = 'ì›ë³¸';
    setDefaultDate();
    saveData();
  }

  function setDefaultDate() {
    const now = new Date();
    const offset = 9 * 60 * 60 * 1000;
    const kst = new Date(now.getTime() + offset);
    const yyyy = kst.getFullYear();
    const mm = String(kst.getMonth() + 1).padStart(2, '0');
    const dd = String(kst.getDate()).padStart(2, '0');
    document.getElementById('shoot_date').value = `${yyyy}-${mm}-${dd}`;
  }

  function generateContent() {
    const fields = [
      ['ì˜ë¢°ì', 'client'], 
      ['ì˜ë¢°í˜•ì‹', 'request_type'], 
      ['ì´¬ì˜ì¼', 'shoot_date'], 
      ['ê¸°ì ë™í–‰ ì—¬ë¶€', 'reporter_accompany'], // ìˆ˜ì • ë°˜ì˜
      ['ëŒ€ë¶„ë¥˜', 'category_main'], 
      ['ì†Œë¶„ë¥˜', 'category_sub'], 
      ['ì œëª©', 'title'], 
      ['íŠ¹ì´ì‚¬í•­', 'notes'], 
      ['ì´¬ì˜ë‚´ìš©', 'content'], 
      ['ì´¬ì˜ì¥ì†Œ', 'location'], 
      ['ì˜ìƒê¸°ì', 'videographer'], 
      ['ì·¨ì¬ê¸°ì', 'reporter'], 
      ['ì˜ìƒPD/VJ', 'vj'], 
      ['ì¹´ë“œë²ˆí˜¸', 'card_number'], 
      ['ì´¬ì˜ì¥ë¹„', 'equipment']
    ];
    let content = ``;
    fields.forEach(([label, id], idx) => {
  content += `${label}: ${document.getElementById(id).value}`;
  if (idx < fields.length - 1) content += `\n`;
});
    return content;
  }

  function downloadTXT() {
    const content = generateContent();
    const blob = new Blob([content], { type: 'text/plain' });
    const a = document.createElement('a');
    const now = new Date();
    const yyyy = now.getFullYear();
    const mm = String(now.getMonth() + 1).padStart(2, '0');
    const dd = String(now.getDate()).padStart(2, '0');
    const hh = String(now.getHours()).padStart(2, '0');
    const min = String(now.getMinutes()).padStart(2, '0');
    const ss = String(now.getSeconds()).padStart(2, '0');
    const dateStr = `${yyyy}${mm}${dd}`;
    const timeStr = `${hh}${min}${ss}`;
    const title = document.getElementById('title').value.replace(/[^a-zA-Z0-9ê°€-í£]/g, '').slice(0, 20);
    const filename = `${dateStr}_${timeStr}_${title || "Untitled"}.txt`;
    a.href = URL.createObjectURL(blob);
    a.download = filename;
    a.click();
  }

  function copyAndShare() {
    const content = generateContent();
    navigator.clipboard.writeText(content).then(() => {
      alert("ë‚´ìš©ì´ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤. ì¹´ì¹´ì˜¤í†¡ì—ì„œ ë¶™ì—¬ë„£ê¸° í•˜ì„¸ìš”.");
    });
  }

  function confirmReset() {
    if (confirm("ì •ë§ ë¦¬ì…‹ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
      resetForm();
    }
  }

  function saveToServer(isAuto = false) {
    if (!currentUser) return;
    const data = {};
    document.querySelectorAll('#form-section input, #form-section textarea').forEach(el => {
      data[el.id] = el.value;
    });
    db.ref('ingest_notes/' + currentUser).set(data).then(() => {
      if (!isAuto) alert("ì„œë²„ì— ë™ê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.");
    });
  }

  function loadFromServer() {
    if (!currentUser) return;
    db.ref('ingest_notes/' + currentUser).once('value').then(snapshot => {
      const data = snapshot.val();
      if (data) {
        Object.entries(data).forEach(([key, value]) => {
          const el = document.getElementById(key);
          if (el) el.value = value;
        });
      }
    });
  }

  function saveData() {
    if (!currentUser) return;
    const data = {};
    document.querySelectorAll('#form-section input, #form-section textarea').forEach(el => {
      data[el.id] = el.value;
    });
    localStorage.setItem('ingest_data_' + currentUser, JSON.stringify(data));
  }

  function loadData() {
    if (!currentUser) return;
    const data = JSON.parse(localStorage.getItem('ingest_data_' + currentUser) || '{}');
    Object.entries(data).forEach(([key, value]) => {
      const el = document.getElementById(key);
      if (el) el.value = value;
    });
  }

  function openSMSPopup() {
    document.getElementById('sms-popup').style.display = 'block';
  }

  function closeSMSPopup() {
    document.getElementById('sms-popup').style.display = 'none';
    document.getElementById('sms-text').value = '';
  }



function parseSMSAndInsert() {
  const sms = document.getElementById('sms-text').value.trim();
  const firstLine = sms.split('\n')[0];
  const parts = firstLine.split(',').map(e => e.trim());

  const title = parts[0] || "";
  const reporter = parts[1] || "";
  const third = parts[2] || "";
  const accompany = parts[3] || ""; // ìˆ˜ì • ë°˜ì˜: ê¸°ì ë™í–‰ ì—¬ë¶€
  const location = parts[4] || "";

  const VJ_NAMES = [
    "ì´ì£¼í˜", "ë…ê³ ëª…", "ê¹€ë°±ìŠ¹", "ê°•ì¬í›ˆ", "ì´ê´€í˜¸", 
    "ì„ì§€í™˜", "ì´ì›ì„", "ìš°ì„±í›ˆ", "ê¹€ì°½ì¸", "ì†Œì •ì„­", "ë‚¨í˜„íƒ", "ê°•ì¢…ìˆ˜",
    "í™©ì£¼ì—°", "ê¹€ë¯¼ìŠ¹", "ì •ì˜ì§„", "í•œì¬í›ˆ", "ì´ìƒìš©", "ìœ¤ë³‘ìˆœ", "ì „íš¨ì„"
  ];

  if (title) {
    document.getElementById('title').value = title;
    const contentBox = document.getElementById('content');
    contentBox.value = title + '\n' + contentBox.value;
  }

  if (reporter) {
    document.getElementById('reporter').value = reporter;
  }
  
  // ìˆ˜ì • ë°˜ì˜: ê¸°ì ë™í–‰ ì—¬ë¶€ ì…ë ¥
  if (accompany) {
    document.getElementById('reporter_accompany').value = accompany;
  }


  if (third) {
    const isVJ = VJ_NAMES.includes(third);
    if (isVJ) {
      document.getElementById('vj').value = third;
      document.getElementById('equipment').value = "6mm";
    } else {
      document.getElementById('videographer').value = third;
      document.getElementById('equipment').value = "ENG";
    }
    document.getElementById('client').value = third;
  }

  if (location) {
    document.getElementById('location').value = location;
  }

  closeSMSPopup();
  saveData();
}



  document.getElementById('login-code').addEventListener('keydown', function(event) {
    if (event.key === 'Enter') login();
  });

  document.addEventListener("DOMContentLoaded", function() {
    const loginSection = document.getElementById("login-section");
    const formSection = document.getElementById("form-section");
    const logoWrapper = document.getElementById("login-logo-wrapper");
    function updateVisibility() {
      logoWrapper.style.display = loginSection.classList.contains("active") ? "block" : "none";
    }
    updateVisibility();
    const observer = new MutationObserver(updateVisibility);
    observer.observe(loginSection, { attributes: true, attributeFilter: ["class"] });
  });

  let autoSaveTimer;
  document.querySelectorAll('#form-section input, #form-section textarea').forEach(el => {
    el.addEventListener('input', () => {
      if (autoSaveTimer) clearTimeout(autoSaveTimer);
      autoSaveTimer = setTimeout(() => saveToServer(true), 10000);
    });
  });


function showCanteen() {
  document.getElementById('login-section').style.display = 'none';
  document.getElementById('form-section').style.display = 'none';
  document.getElementById('canteen-section').style.display = 'block';
  loadCanteenImages();
}

function handleCanteenUpload(event) {
  const gallery = document.getElementById('canteen-gallery');
  const files = Array.from(event.target.files);
  files.forEach(file => {
    const reader = new FileReader();
    reader.onload = function(e) {
      const key = file.name;
      const today = new Date();
      const fileDate = new Date("20" + key.substring(0, 2), parseInt(key.substring(2, 4)) - 1, key.substring(4, 6));
      if (fileDate >= today) {
        localStorage.setItem("canteen_" + key, e.target.result);
      }
      loadCanteenImages();
    };
    reader.readAsDataURL(file);
  });
}

function loadCanteenImages() {
  const gallery = document.getElementById('canteen-gallery');
  gallery.innerHTML = "";
  const today = new Date();
  for (let key in localStorage) {
    if (key.startsWith("canteen_")) {
      const dateStr = key.replace("canteen_", "").replace(".png", "");
      const date = new Date("20" + dateStr.substring(0, 2), parseInt(dateStr.substring(2, 4)) - 1, dateStr.substring(4, 6));
      if (date < today) {
        localStorage.removeItem(key);
        continue;
      }
      const img = document.createElement("img");
      img.src = localStorage.getItem(key);
      img.alt = key;
      img.style.maxWidth = "150px";
      img.style.maxHeight = "150px";
      img.style.border = "1px solid #ccc";
      gallery.appendChild(img);
    }
  }
}
</script>
<script>
function showCanteen() {
  document.getElementById('login-section').style.display = 'none';
  document.getElementById('form-section').style.display = 'none';
  document.getElementById('canteen-section').style.display = 'block';
  loadCanteenImages();
}

function handleCanteenUpload(event) {
  const storageRef = firebase.storage().ref("canteen");
  const files = Array.from(event.target.files);

  files.forEach(file => {
    const fileName = file.name;
    const fileDate = new Date("20" + fileName.substring(0, 2), parseInt(fileName.substring(2, 4)) - 1, fileName.substring(4, 6));
    const today = new Date();
    today.setHours(0, 0, 0, 0);

    if (fileDate >= today) {
      const ref = storageRef.child(fileName);
      ref.put(file).then(() => {
        loadCanteenImages();
      });
    } else {
      alert(fileName + " ì€ ê³¼ê±° ë‚ ì§œì´ë¯€ë¡œ ì—…ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
    }
  });
}

function loadCanteenImages() {
  const gallery = document.getElementById('canteen-gallery');
  gallery.innerHTML = '';
  const today = new Date();
  today.setHours(0, 0, 0, 0);

  const storageRef = firebase.storage().ref("canteen");
  storageRef.listAll().then(res => {
    res.items.forEach(itemRef => {
      const fileName = itemRef.name;
      const fileDate = new Date("20" + fileName.substring(0, 2), parseInt(fileName.substring(2, 4)) - 1, fileName.substring(4, 6));

      if (fileDate < today) {
        // ê³¼ê±° ë‚ ì§œë©´ ì‚­ì œ
        itemRef.delete();
      } else {
        itemRef.getDownloadURL().then(url => {
          const img = document.createElement("img");
          img.src = url;
          img.alt = fileName;
          img.style.maxWidth = "150px";
          img.style.maxHeight = "150px";
          img.style.border = "1px solid #ccc";
          gallery.appendChild(img);
        });
      }
    });
  });
}
</script>
<div id="meal-section" style="display:none; text-align:center; margin-top:30px;">
<img alt="ì‹ë‹¨ ì´ë¯¸ì§€" id="meal-image" src="meal.jpg" style="max-width:90%; height:auto; border:1px solid #ccc;"/>
<div style="margin-top:10px;">
<button onclick="downloadMealImage()">ë‹¤ìš´ë¡œë“œ</button>
</div>
</div>
<script>
function showMealPage() {
  document.getElementById('login-section').style.display = 'none';
  document.getElementById('form-section').style.display = 'none';
  document.getElementById('meal-section').style.display = 'block';
}

function downloadMealImage() {
  const link = document.createElement('a');
  link.href = document.getElementById('meal-image').src;
  link.download = "meal.jpg";
  link.click();
}
</script>
<script>
// ğŸŸ¢ ìƒˆë¡œ ì¶”ê°€ëœ Firebase ì´ë¯¸ì§€ ë¡œë“œ í•¨ìˆ˜
function loadMealImagesFromFirebase() {
  const gallery = document.getElementById('meal-gallery');
  gallery.innerHTML = '';
  const storageRef = firebase.storage().ref("meal");
  storageRef.listAll().then(res => {
    res.items.forEach(itemRef => {
      itemRef.getDownloadURL().then(url => {
        const img = document.createElement('img');
        img.src = url;
        img.alt = itemRef.name;
        img.style.maxWidth = '100%';
        img.style.height = 'auto';
        img.style.cursor = 'pointer';
        img.onclick = () => {
          document.querySelectorAll('#meal-gallery img').forEach(i => i.style.border = '1px solid #ccc');
          img.style.border = '3px solid red';
          selectedMealImg = itemRef.name.replace(".png", "");
        };
        gallery.appendChild(img);
      });
    });
  }).catch(err => {
    alert("ì´ë¯¸ì§€ ë¡œë”© ì‹¤íŒ¨: " + err.message);
  });
}

// ğŸŸ¢ ì„œë²„ ë²„íŠ¼ ê°œì„  - ì„±ê³µ/ì‹¤íŒ¨ íŒì—…
function syncMealToFirebase() {
  const storageRef = firebase.storage().ref("meal");
  const mealKeys = Object.keys(localStorage).filter(key => key.startsWith("meal_"));
  if (mealKeys.length === 0) {
    alert("ì—…ë¡œë“œí•  ì´ë¯¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.");
    return;
  }

  let successCount = 0;
  let failCount = 0;
  let total = mealKeys.length;

  mealKeys.forEach(key => {
    const dataUrl = localStorage.getItem(key);
    const file = dataURLtoBlob(dataUrl);
    const ref = storageRef.child(key + ".png");

    ref.put(file)
      .then(() => {
        successCount++;
        checkDone();
      })
      .catch(() => {
        failCount++;
        checkDone();
      });
  });

  function checkDone() {
    if (successCount + failCount === total) {
      if (failCount === 0) {
        alert("ì„œë²„ì— ë™ê¸°í™” ì™„ë£Œ!");
      } else {
        alert(\`ì¼ë¶€ ì‹¤íŒ¨: \${failCount}ê°œ ì´ë¯¸ì§€ ì—…ë¡œë“œ ì‹¤íŒ¨\`);
      }
    }
  }
}

// ğŸ” showMealPage ìˆ˜ì • - Firebaseì—ì„œ ì´ë¯¸ì§€ ë¡œë“œ
function showMealPage() {
  document.getElementById('login-section').style.display = 'none';
  document.getElementById('form-section').style.display = 'none';
  document.getElementById('meal-section').style.display = 'block';
  loadMealImagesFromFirebase();
}
</script>
<div id="audio-process-section" style="display:none;">
<h1 style="text-align:center; color:#2c3e50; margin-bottom:2rem;">ğŸ§ ì˜¤ë””ì˜¤ë§¨ ì—…ë¬´ í”„ë¡œì„¸ìŠ¤</h1>
<div class="process-section">
<h2>1. ì¶œê·¼</h2>
<ul>
<li>ì¸ì œìŠ¤íŠ¸ë£¸ì—ì„œ ì „ë‚  ë§¡ê¸´ ì¹´ë“œ/í•˜ë“œ ìˆ˜ë ¹</li>
<li>ê¸ˆì¼ ì¶œê·¼í•  ì„ ë°°ë‹˜ë“¤ ì¥ë¹„ ì ê²€ (ì™€ì´ì–´ë¦¬ìŠ¤ CH1, 2 ìˆ˜ìŒ ì²´í¬ / ë°°í„°ë¦¬ ìƒíƒœ í™•ì¸ / 3ì¼ ì§€ë‚œ ë©”ëª¨ë¦¬ ì¹´ë“œ í¬ë§·)</li>
</ul>
</div>
<div class="process-section">
<h2>2. ì¼ì • ì¤€ë¹„</h2>
<ul>
<li>ì˜ìƒê¸°ì/PD/VJ ì„ ë°°ë‹˜ê»˜ ìš°ì„  ì—°ë½</li>
<li>ì˜ë¢°ì„œ í™•ì¸ ë° ë³¸ì¸ì—ê²Œ SMS ë³´ë‚´ê¸° (ë©”ëª¨ìš©)</li>
<li>ì¶œë°œ 15~20ë¶„ ì „ ë°°ì°¨ ìš”ì²­</li>
<li>ì„ ë°°ë‹˜ ì§€ì‹œ ì‚¬í•­ì— ë”°ë¼ ì¥ë¹„ ì±™ê¸°ê¸° (ê²Œë‹¤ìŠ¤, ê³ í”„ë¡œ, ì˜¤ì¦ˆëª¨, ìš°ì‚° ë“±)</li>
</ul>
</div>
<div class="process-section">
<h2>3. ì¼ì • ì´ë™</h2>
<ul>
<li>ì°¨ëŸ‰ íŠ¸ë í¬ì— íŠ¸ë¼ì´ ë° ì§ê°€ë°© ì ì¬ (6mm, ENG ì¹´ë©”ë¼ëŠ” ì„ ë°°ë‹˜ì´ ë’·ìë¦¬)</li>
<li>í˜•ë‹˜ ë²ˆí˜¸ í™•ì¸ (ì·¨ì¬ ì¢…ë£Œ í›„ ì†Œí†µìš©)</li>
<li>ëª©ì ì§€ ì£¼ì†Œ ì •í™•íˆ ì „ë‹¬</li>
</ul>
</div>
<div class="process-section">
<h2>4. ì¼ì • ì¥ì†Œ ë„ì°© ë° ì‹œì‘</h2>
<ul>
<li>íŠ¸ë¼ì´ ì„¸íŒ… (ìƒí™©ì— ë”°ë¼ ìœ„ë¶€í„° ì„¸íŒ… ê°€ëŠ¥)</li>
<li>í™”ì´íŠ¸ë°¸ëŸ°ìŠ¤ ì²´í¬</li>
<li>ì‹±í¬/ì¸í„°ë·° ëŒ€ë¹„ ì™€ì´ì–´ë¦¬ìŠ¤ ì£¼ë¨¸ë‹ˆì— ë„£ì–´ë‘ê¸°</li>
<li>ë ˆì½”ë”© í™”ë©´ ë³´ë©° ì¸ë±ìŠ¤ ì •ë¦¬</li>
<li>ê¸´ê¸‰ ì´ë™ ì‹œ ì¥ë¹„ íŒŒì† ì£¼ì˜í•˜ë©° ë™í–‰</li>
<li>ì¸í„°ë·° ì‹œ ì´ë¦„ ë°˜ë“œì‹œ í™•ì¸ (ëª¨ìì´í¬/ìµëª… ì—¬ë¶€ ì²´í¬)</li>
<li>íŠ¹ì´ì‚¬í•­ì€ ì¸ë±ìŠ¤ì— ê¼­ ê¸°ì…</li>
</ul>
</div>
<div class="process-section">
<h2>5. ì¼ì • ë³µê·€ ë° ì¸ì œìŠ¤íŠ¸</h2>
<ul>
<li>ì°¨ëŸ‰ìš´í–‰ ì¼ì§€ ì‘ì„± (í˜•ë‹˜ ì œê³µ)</li>
<li>ì§ì´ ë§ì„ ê²½ìš° ë„ì›€ ìš”ì²­ (ì¹´í†¡)</li>
<li>ê¸°ì¬ì‹¤ ë„ì°© í›„ ì¸ì œìŠ¤íŠ¸ â†’ ì¥ë¹„ ì •ë¦¬</li>
<li>ì¸ë±ìŠ¤ í™•ì¸ â†’ MIDASì— ê¸°ì… ë° ì €ì¥</li>
<li>ë°”ì½”ë“œ 2ì¥ ì¶œë ¥ í›„ ê°ê° ì¼€ì´ìŠ¤ì™€ íŒŒì¼ì² ì— ë¶€ì°©</li>
<li>ëª¨ë“  ì¥ë¹„ ì •ë¦¬ í›„ íœ´ì‹</li>
</ul>
</div>
</div>
<script>
function showAudioProcess() {
  document.getElementById('login-section').style.display = 'none';
  document.getElementById('form-section').style.display = 'none';
  document.getElementById('meal-section').style.display = 'none';
  document.getElementById('audio-process-section').style.display = 'block';
}
</script>
<style>

    body {
  text-align: left;
      font-family: 'Pretendard', sans-serif;
      background-color: #f9f9f9;
      margin: 0;
      padding: 2rem;
      color: #333;
    }

    h1 {
      text-align: center;
      color: #2c3e50;
      margin-bottom: 2rem;
    }

    .process-section {
      background-color: #ffffff;
      border-left: 5px solid #3498db;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }

    .process-section h2 {
      color: #2980b9;
      margin-top: 0;
    }

    ul {
      padding-left: 1.5rem;
    }

    li {
      margin-bottom: 0.6rem;
      line-height: 1.6;
    }

    @media (max-width: 600px) {
      body {
  text-align: left;
        padding: 1rem;
      }
    }
  
</style>
<div id="audio-process-section" style="display:none;">
<h1 style="text-align:center; color:#2c3e50; margin-bottom:2rem;">ğŸ§ ì˜¤ë””ì˜¤ë§¨ ì—…ë¬´ í”„ë¡œì„¸ìŠ¤</h1>
<div class="process-section">
<h2>1. ì¶œê·¼</h2>
<ul>
<li>ì¸ì œìŠ¤íŠ¸ë£¸ì—ì„œ ì „ë‚  ë§¡ê¸´ ì¹´ë“œ/í•˜ë“œ ìˆ˜ë ¹</li>
<li>ê¸ˆì¼ ì¶œê·¼í•  ì„ ë°°ë‹˜ë“¤ ì¥ë¹„ ì ê²€ (ì™€ì´ì–´ë¦¬ìŠ¤ CH1, 2 ìˆ˜ìŒ ì²´í¬ / ë°°í„°ë¦¬ ìƒíƒœ í™•ì¸ / 3ì¼ ì§€ë‚œ ë©”ëª¨ë¦¬ ì¹´ë“œ í¬ë§·)</li>
</ul>
</div>
<div class="process-section">
<h2>2. ì¼ì • ì¤€ë¹„</h2>
<ul>
<li>ì˜ìƒê¸°ì/PD/VJ ì„ ë°°ë‹˜ê»˜ ìš°ì„  ì—°ë½</li>
<li>ì˜ë¢°ì„œ í™•ì¸ ë° ë³¸ì¸ì—ê²Œ SMS ë³´ë‚´ê¸° (ë©”ëª¨ìš©)</li>
<li>ì¶œë°œ 15~20ë¶„ ì „ ë°°ì°¨ ìš”ì²­</li>
<li>ì„ ë°°ë‹˜ ì§€ì‹œ ì‚¬í•­ì— ë”°ë¼ ì¥ë¹„ ì±™ê¸°ê¸° (ê²Œë‹¤ìŠ¤, ê³ í”„ë¡œ, ì˜¤ì¦ˆëª¨, ìš°ì‚° ë“±)</li>
</ul>
</div>
<div class="process-section">
<h2>3. ì¼ì • ì´ë™</h2>
<ul>
<li>ì°¨ëŸ‰ íŠ¸ë í¬ì— íŠ¸ë¼ì´ ë° ì§ê°€ë°© ì ì¬ (6mm, ENG ì¹´ë©”ë¼ëŠ” ì„ ë°°ë‹˜ì´ ë’·ìë¦¬)</li>
<li>í˜•ë‹˜ ë²ˆí˜¸ í™•ì¸ (ì·¨ì¬ ì¢…ë£Œ í›„ ì†Œí†µìš©)</li>
<li>ëª©ì ì§€ ì£¼ì†Œ ì •í™•íˆ ì „ë‹¬</li>
</ul>
</div>
<div class="process-section">
<h2>4. ì¼ì • ì¥ì†Œ ë„ì°© ë° ì‹œì‘</h2>
<ul>
<li>íŠ¸ë¼ì´ ì„¸íŒ… (ìƒí™©ì— ë”°ë¼ ìœ„ë¶€í„° ì„¸íŒ… ê°€ëŠ¥)</li>
<li>í™”ì´íŠ¸ë°¸ëŸ°ìŠ¤ ì²´í¬</li>
<li>ì‹±í¬/ì¸í„°ë·° ëŒ€ë¹„ ì™€ì´ì–´ë¦¬ìŠ¤ ì£¼ë¨¸ë‹ˆì— ë„£ì–´ë‘ê¸°</li>
<li>ë ˆì½”ë”© í™”ë©´ ë³´ë©° ì¸ë±ìŠ¤ ì •ë¦¬</li>
<li>ê¸´ê¸‰ ì´ë™ ì‹œ ì¥ë¹„ íŒŒì† ì£¼ì˜í•˜ë©° ë™í–‰</li>
<li>ì¸í„°ë·° ì‹œ ì´ë¦„ ë°˜ë“œì‹œ í™•ì¸ (ëª¨ìì´í¬/ìµëª… ì—¬ë¶€ ì²´í¬)</li>
<li>íŠ¹ì´ì‚¬í•­ì€ ì¸ë±ìŠ¤ì— ê¼­ ê¸°ì…</li>
</ul>
</div>
<div class="process-section">
<h2>5. ì¼ì • ë³µê·€ ë° ì¸ì œìŠ¤íŠ¸</h2>
<ul>
<li>ì°¨ëŸ‰ìš´í–‰ ì¼ì§€ ì‘ì„± (í˜•ë‹˜ ì œê³µ)</li>
<li>ì§ì´ ë§ì„ ê²½ìš° ë„ì›€ ìš”ì²­ (ì¹´í†¡)</li>
<li>ê¸°ì¬ì‹¤ ë„ì°© í›„ ì¸ì œìŠ¤íŠ¸ â†’ ì¥ë¹„ ì •ë¦¬</li>
<li>ì¸ë±ìŠ¤ í™•ì¸ â†’ MIDASì— ê¸°ì… ë° ì €ì¥</li>
<li>ë°”ì½”ë“œ 2ì¥ ì¶œë ¥ í›„ ê°ê° ì¼€ì´ìŠ¤ì™€ íŒŒì¼ì² ì— ë¶€ì°©</li>
<li>ëª¨ë“  ì¥ë¹„ ì •ë¦¬ í›„ íœ´ì‹</li>
</ul>
</div>
</div>
<script>
function showAudioProcess() {
  document.getElementById('login-section').style.display = 'none';
  document.getElementById('form-section').style.display = 'none';
  document.getElementById('meal-section').style.display = 'none';
  document.getElementById('audio-process-section').style.display = 'block';
}
</script>

<script>
  function goToRecordPage() {
    const code = document.getElementById('login-code').value;
    if (allowedCodes.includes(code)) {
      window.location.href = 'record.html?user=' + encodeURIComponent(code);
    } else {
      alert("ë¡œê·¸ì¸ ì½”ë“œê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.");
    }
  }
</script>

</body>
</html>

<style>
  /* Meal gallery styles */
  #meal-section-v2 { display:none; text-align:center; margin:30px auto; max-width:900px; }
  #meal-main { width: 100%; max-width: 350px; height: 300px; object-fit: contain; border:1px solid #ccc; border-radius:8px; display:block; margin:0 auto; }
  .meal-controls { margin-top:12px; display:flex; gap:8px; justify-content:center; flex-wrap:wrap; }
  .meal-controls button { background:#004080; color:#fff; border:none; border-radius:8px; padding:10px 14px; cursor:pointer; }
  .meal-controls button:hover { background:#003060; }
  #meal-gallery { 
    margin-top:16px; 
    display:grid; 
    grid-template-columns: repeat(auto-fill, minmax(140px,1fr));
    gap:10px;
    align-items:start;
  }
  #meal-gallery img {
    width:100%; height:auto; border:1px solid #ccc; border-radius:6px; cursor:pointer;
  }
  #meal-gallery img.active { outline:3px solid #ff5252; }
</style>

<div id="meal-section-v2">
  <div id="visitor-counter">ğŸ‘€ ë°°ê³ í”ˆ ì‚¬ëŒ: 0</div>
  <img id="meal-main" alt="ì‹ë‹¨ ì´ë¯¸ì§€(ë¯¸ë¦¬ë³´ê¸°)" src="">
  <div class="meal-controls">
    <button id="meal-upload-btn" type="button">ì—…ë¡œë“œ</button>
    <button id="meal-download-btn" type="button">ë‹¤ìš´ë¡œë“œ</button>
    </div>
  <input id="meal-file-input" type="file" accept="image/*" style="display:none">
  <div id="meal-gallery" aria-label="ì—…ë¡œë“œëœ ì‹ë‹¨ ì´ë¯¸ì§€ ëª©ë¡" style="display:none"></div>
</div>

<script>
  // Override the old showMealPage() to use the new v2 section
  function showMealPage() {
    // hide others
    document.getElementById('login-section').style.display = 'none';
    var fs = document.getElementById('form-section');
    if (fs) fs.style.display = 'none';
    var oldMeal = document.getElementById('meal-section');
    if (oldMeal) oldMeal.style.display = 'none';
    var audio = document.getElementById('audio-process-section');
    if (audio) audio.style.display = 'none';
    // show new
    document.getElementById('meal-section-v2').style.display = 'block';
    loadMealImagesFromFirebase_v2();
  }

  // Utility: make a timestamped filename to keep order
  function tsFileName(ext) {
    var d = new Date();
    var pad = n => String(n).padStart(2,'0');
    var name = d.getFullYear().toString() + pad(d.getMonth()+1) + pad(d.getDate()) + "_" + pad(d.getHours()) + pad(d.getMinutes()) + pad(d.getSeconds());
    return name + "." + ext.toLowerCase();
  }

  // Upload flow guarded by password
  document.addEventListener('click', function(e){
    if (e.target && e.target.id === 'meal-upload-btn') {
      var pw = prompt('ì‹ë‹¨í‘œ ì—…ë¡œë“œ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.');
      if (pw !== 'rjsgh1') { alert('ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë¦½ë‹ˆë‹¤.'); return; }
      document.getElementById('meal-file-input').click();
    }
    if (e.target && e.target.id === 'meal-download-btn') {
      var img = document.getElementById('meal-main');
      var a = document.createElement('a');
      a.href = img.src;
      a.download = 'meal.jpg';
      a.click();
    }
    if (e.target && e.target.id === 'meal-refresh-btn') {
      loadMealImagesFromFirebase_v2();
    }
  });

  document.getElementById('meal-file-input').addEventListener('change', function(e){
    var file = e.target.files && e.target.files[0];
    if (!file) return;
    var ext = (file.name.split('.').pop() || 'png');
    var path = 'meal/' + tsFileName(ext);
    var ref = firebase.storage().ref(path);
    ref.put(file).then(function(){ 
      return ref.getDownloadURL();
    }).then(function(url){
      document.getElementById('meal-main').src = url;
      alert('ì—…ë¡œë“œ ì™„ë£Œ!');
      loadMealImagesFromFirebase_v2();
      e.target.value = '';
    }).catch(function(err){
      alert('ì—…ë¡œë“œ ì‹¤íŒ¨: ' + err.message);
    });
  });

  // Load gallery from Firebase Storage (folder: meal/)
  function loadMealImagesFromFirebase_v2() {
    var gallery = document.getElementById('meal-gallery');
    var main = document.getElementById('meal-main');
    gallery.innerHTML = '';
    var storageRef = firebase.storage().ref('meal');
    storageRef.listAll().then(function(res){
      if (!res.items.length) { return; }
      // Fetch URLs with names, then sort by name desc (timestamped)
      var promises = res.items.map(function(itemRef){
        return itemRef.getDownloadURL().then(function(url){ 
          return { name: itemRef.name, url: url }; 
        });
      });
      Promise.all(promises).then(function(items){
        items.sort(function(a,b){ return a.name < b.name ? 1 : (a.name > b.name ? -1 : 0); });
        // Set main to newest
        main.src = items[0].url;
        // Render gallery
        items.forEach(function(it, idx){
          var img = document.createElement('img');
          img.src = it.url;
          img.alt = it.name;
          if (idx === 0) img.classList.add('active');
          img.onclick = function(){
            document.querySelectorAll('#meal-gallery img').forEach(function(i){ i.classList.remove('active'); });
            img.classList.add('active');
            main.src = it.url;
          };
          gallery.appendChild(img);
        });
      });
    }).catch(function(err){
      alert('ì´ë¯¸ì§€ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨: ' + err.message);
    });
  }


  // ===== Firebase visitor counter (daily reset) =====
  function incrementVisitorCount(){
    var today = new Date();
    var y = today.getFullYear();
    var m = ('0' + (today.getMonth()+1)).slice(-2);
    var d = ('0' + today.getDate()).slice(-2);
    var dateKey = y + "-" + m + "-" + d;

    var counterRef = firebase.database().ref("mealPageVisitors/" + dateKey + "/count");
    counterRef.once("value").then(function(snapshot){
      var currentCount = snapshot.exists() ? snapshot.val() : 0;
      currentCount++;
      counterRef.set(currentCount).then(function(){
        document.getElementById('visitor-counter').textContent = "ğŸ‘€ ë°°ê³ í”ˆ ì‚¬ëŒ: " + currentCount;
      });
    }).catch(function(err){
      console.error("ë°©ë¬¸ì ìˆ˜ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:", err);
    });
  }

  // Override showMealPage to increment counter
  var originalShowMealPage = showMealPage;
  showMealPage = function(){
    originalShowMealPage();
    incrementVisitorCount();
  };
  // ===== /Firebase visitor counter (daily reset) =====

</script>
